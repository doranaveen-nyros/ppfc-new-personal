@page "/admin/usercreation"
@using ppfc.DTO
@using Radzen
@using Radzen.Blazor
@attribute [Authorize]
@inject HttpClient Http
@inject NotificationService NotificationService
@inject DialogService DialogService

<RadzenNotification />

<PageTitle>User Creation</PageTitle>

@if (IsLoading)
{
    <div class="d-flex flex-column align-items-center justify-content-center vh-100 text-muted">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <p>Loading users...</p>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h3 class="mb-0">User Creation</h3>
        </div>
        <RadzenButton Icon="add_circle"
                      Text="Add New"
                      Click="@AddNew"
                      Style="margin-bottom:6px"
                      ButtonStyle="ButtonStyle.Secondary" />
    </div>

    <RadzenDataGrid @ref="grid" TItem="UserDto" FilterMode="FilterMode.Simple" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Data="@users" EditMode="DataGridEditMode.Single" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true" PagerHorizontalAlign="HorizontalAlign.Right">
        <Columns>
            <RadzenDataGridColumn TItem="UserDto" Property="EmployeeName" Title="Employee" FilterPlaceholder="Search Employee...">
                <EditTemplate Context="user">
                    <RadzenDropDown Data="@employees"
                                    TextProperty="EmployeeName"
                                    ValueProperty="EmployeeId"
                                    @bind-Value="user.EmployeeId"
                                    Style="width:100%"
                                    Placeholder="Select Employee"
                                    AllowClear="true" />
                </EditTemplate>
                <Template Context="user">
                    @user.EmployeeName
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="UserDto" Property="UserName" Title="Username" FilterPlaceholder="Username...">
                <EditTemplate Context="user">
                    <RadzenTextBox Style="width:100%" @bind-Value="user.UserName" Placeholder="Enter username" />
                    <RadzenRequiredValidator Text="ShipName is required" Component="UserName" Popup="true" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="UserDto" Property="RoleName" Title="Role" FilterPlaceholder="Search Role...">
                <EditTemplate Context="user">
                    <RadzenDropDown Data="@roles" TextProperty="RoleName"
                                    ValueProperty="RoleId" @bind-Value="user.RoleId" Style="width:100%" Placeholder="Select Role" />
                    <RadzenRequiredValidator Text="Role is required" Component="RoleName" Popup="true" />
                </EditTemplate>
                <Template Context="user">
                    @user.RoleName
                </Template>
            </RadzenDataGridColumn>

            <!-- Password column visible after save; during edit we show password + confirm fields -->
            <RadzenDataGridColumn TItem="UserDto" Property="Password" Title="Password" Filterable="false">
                <Template Context="user">
                    @((string.IsNullOrEmpty(user.Password) ? "-" : new string('*', user.Password.Length)))
                </Template>
                <EditTemplate Context="user">
                    <div class="mb-2">
                        @* <RadzenPassword Style="width:100%" @bind-Value="user.Password" Placeholder="Password" /> *@
                        <RadzenTextBox @bind-Value="user.Password"
                                       Placeholder="Enter password"
                                       Visible="@ShowPassword" />
                        <RadzenPassword @bind-Value="user.Password"
                                        Placeholder="Enter password"
                                        Visible="@( !ShowPassword )" />
                        <RadzenButton Icon="@(ShowPassword ? "visibility_off" : "visibility")"
                                      Click="Toggle"
                                      Style="margin-left:8px"
                                      Variant="Variant.Text"
                                      Size="ButtonSize.Small" />
                    </div>
                    <div>
                        <RadzenPassword Style="width:100%" @bind-Value="user.ConfirmPassword" Placeholder="Confirm Password" />
                    </div>
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="UserDto" Title="Actions" Width="150px" Filterable="false">
                <Template Context="user">
                    @if (EditLoadingUserId == user.UserId)
                    {
                        <div class="spinner-border spinner-border-sm text-dark" role="status" style="margin-right: 13px; margin-left: 5px;"></div>
                    }
                    else
                    {
                        <RadzenButton Icon="edit" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@(args => EditUser(user))" Style="background:transparent;color: #000;margin-right:6px" />
                    }
                    @if (DelLoadingUserId == user.UserId)
                    {
                        <div class="spinner-border spinner-border-sm text-danger" role="status" style="margin-right: 13px; margin-left: 5px;"></div>
                    }
                    else
                    {
                        <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Click="@(args => DeleteUser(user))" Style="background:transparent;margin-right:6px;color:red" />
                    }
                </Template>
                <EditTemplate Context="user">
                    @if(IsSubmitting){
                    <div class="spinner-border spinner-border-sm text-danger" role="status" style="margin-right: 13px; margin-left: 5px;"></div>
                    }
                    else{
                    <RadzenButton Icon="save" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Click="@(args => SaveUser(user))" Style="margin-right:6px;" />
                    }
                    <RadzenButton Icon="close" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@(args => CancelEdit(user))" />
                </EditTemplate>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>

}