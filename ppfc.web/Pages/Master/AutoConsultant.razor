@page "/master/autoconsultant"
@using Radzen
@using Radzen.Blazor
@using ppfc.DTO
@attribute [Authorize]
@inject HttpClient Http
@inject NotificationService NotificationService
@inject DialogService DialogService

<RadzenNotification />

<PageTitle>Auto Consultant</PageTitle>

@if (IsLoading)
{
    <div class="d-flex flex-column align-items-center justify-content-center vh-100 text-muted">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <p>Loading auto consultants...</p>
    </div>
}
else
{
    <div style= "margin-bottom:10px;" class="d-md-flex justify-content-between align-items-center">
        <div><h3 class="mb-0">Auto Consultant </h3></div>
        <div class="d-md-flex my-3">
            <RadzenButton Icon="download" Text="Export CSV"
                          Click="@ExportToCSV"
                          ButtonStyle="ButtonStyle.Dark"
                          Style="margin-right:10px; border-radius: 4px;" />
            <RadzenButton Icon="add_circle" Text="Add New" Click="@OpenAddModal" ButtonStyle="ButtonStyle.Secondary" />
        </div>
    </div>

    <!-- Data grid -->
    <RadzenDataGrid @ref="grid"
                    Data="@autoConsultants"
                    TItem="AutoConsultantDto"
                    EditMode="DataGridEditMode.Single"
                    AllowPaging="true"
                    AllowFiltering="true"
                    FilterMode="FilterMode.Simple"
                    PageSize="10"
                    PageSizeOptions="@(new int[] {10, 50, 100, autoConsultants.Count })"                    
                    AllowColumnPicking="true"
                    ColumnWidth="150px"
                    ColumnsPickerAllowFiltering="true"
                    AllowSorting="true"
                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"                    
                    PagerHorizontalAlign="HorizontalAlign.Right">
        <Columns>
            <RadzenDataGridColumn TItem="AutoConsultantDto" Property="AutoConsultantName" Width="250px" Title="Auto Consultant" FilterPlaceholder="Search Auto Consultant">
                <Template Context="item">@item.AutoConsultantName</Template>
                <EditTemplate Context="item">
                    <RadzenTextBox @bind-Value="item.AutoConsultantName" Style="width:200%" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="AutoConsultantDto" Property="UPIType" Title="UPI Type" Filterable="false">
                <Template Context="item">@item.UPIType</Template>
                <EditTemplate Context="item">
                    <RadzenTextBox @bind-Value="item.UPIType" Style="width:100%" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="AutoConsultantDto" Property="PhoneNo" Title="Phone" FilterPlaceholder="Search Phone No" Width="200px">
                <Template Context="item">@item.PhoneNo</Template>
                <EditTemplate Context="item">
                    <RadzenTextBox @bind-Value="item.PhoneNo" Style="width:100%" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="AutoConsultantDto" Property="Bank" Title="Bank" Filterable="false">
                <Template Context="item">@item.Bank</Template>
                <EditTemplate Context="item">
                    <RadzenTextBox @bind-Value="item.Bank" Style="width:100%" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="AutoConsultantDto" Property="UPIName" Title="UPIName" Filterable="false">
                <Template Context="item">@item.UPIName</Template>
                <EditTemplate Context="item">
                    <RadzenTextBox @bind-Value="item.UPIName" Style="width:100%" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="AutoConsultantDto" Property="AccountNumber" Title="Account No" FilterPlaceholder="Account No">
                <Template Context="item">@item.AccountNumber</Template>
                <EditTemplate Context="item">
                    <RadzenTextBox @bind-Value="item.AccountNumber" Style="width:100%" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="AutoConsultantDto" Property="AccountName" Title="Account Name" Filterable="false">
                <Template Context="item">@item.AccountName</Template>
                <EditTemplate Context="item">
                    <RadzenTextBox @bind-Value="item.AccountNumber" Style="width:100%" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="AutoConsultantDto" Property="IFSCCode" Title="IFSC Code" Filterable="false">
                <Template Context="item">@item.IFSCCode</Template>
                <EditTemplate Context="item">
                    <RadzenTextBox @bind-Value="item.IFSCCode" Style="width:100%" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="AutoConsultantDto" Property="Lock" Title="Lock" Filterable="false" Width="100px" Frozen="true" FrozenPosition="FrozenColumnPosition.Right" TextAlign="TextAlign.Center">
                @* <Template Context="item">
                    <RadzenSwitch TValue="bool" @bind-Value="item.Lock" />
                </Template>
                <EditTemplate Context="item">
                    <RadzenSwitch TValue="bool" @bind-Value="item.Lock" />
                </EditTemplate> *@
                <Template Context="item">
                    <RadzenSwitch TValue="bool"
                                  Value="@item.Lock"
                                  Change="@(async (bool newValue) => await ToggleLockAsync(item, newValue))" />
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="AutoConsultantDto" Property="Limit" Title="Limit" Filterable="false">
                <Template Context="item">@item.Limit</Template>
                <EditTemplate Context="item">
                    <RadzenNumeric @bind-Value="item.Limit" Style="width:100%" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="AutoConsultantDto" Property="BranchName" Title="Branch" FilterPlaceholder="Search Branch" Width="200px">
                <EditTemplate Context="item">
                    <RadzenDropDown Data="@branches" TextProperty="BranchName" ValueProperty="BranchId" @bind-Value="item.BranchId" Style="width:100%" Placeholder="Select Branch" />
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="AutoConsultantDto" Title="Actions" Width="120px" Frozen="true" FrozenPosition="FrozenColumnPosition.Right" TextAlign="TextAlign.Center">
                <Template Context="item">
                    @if (grid != null && grid.IsRowInEditMode(item))
                    {
                        <RadzenButton Icon="save" Size="ButtonSize.Small" Click="@(args => UpdateConsultant(item))" Style="margin-right:6px;" />
                        <RadzenButton Icon="cancel" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@(args => CancelEdit(item))" />
                    }
                    else
                    {
                        <RadzenButton Icon="edit" Size="ButtonSize.Small" Click="@(args => EditRow(item))" Style="margin-right:6px;" />
                        @if (IsDelLoading == item.AutoConsultantId)
                        {
                            <div class="spinner-border spinner-border-sm text-dark" role="status" style="margin-right: 13px; margin-left: 5px;"></div>
                        }
                        else
                        {
                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@(async args => await DeleteConsultant(item))" />
                        }
                    }
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>

    <!-- Add New Modal (simple Bootstrap-style modal) -->
    @if (isAddModalOpen)
    {
        <div class="modal show" tabindex="-1" style="display:block; background:rgba(0,0,0,0.4);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Auto Consultant</h5>
                        <button type="button" class="btn-close" @onclick="CloseAddModal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@newConsultant">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label>Auto Consultant</label>
                                    <RadzenTextBox @bind-Value="newConsultant.AutoConsultantName" Style="width:100%" />
                                </div>
                                <div class="col-md-3">
                                    <label>UPI Type</label>
                                    <RadzenTextBox @bind-Value="newConsultant.UPIType" Style="width:100%" />
                                </div>
                                <div class="col-md-3">
                                    <label>Phone</label>
                                    <RadzenTextBox @bind-Value="newConsultant.PhoneNo" Style="width:100%" />
                                </div>

                                <div class="col-md-4">
                                    <label>Bank</label>
                                    <RadzenTextBox @bind-Value="newConsultant.Bank" Style="width:100%" />
                                </div>
                                <div class="col-md-4">
                                    <label>UPI Name</label>
                                    <RadzenTextBox @bind-Value="newConsultant.UPIName" Style="width:100%" />
                                </div>
                                <div class="col-md-4">
                                    <label>Account No</label>
                                    <RadzenTextBox @bind-Value="newConsultant.AccountNumber" Style="width:100%" />
                                </div>

                                <div class="col-md-4">
                                    <label>Account Name</label>
                                    <RadzenTextBox @bind-Value="newConsultant.AccountName" Style="width:100%" />
                                </div>
                                <div class="col-md-4">
                                    <label>IFSC</label>
                                    <RadzenTextBox @bind-Value="newConsultant.IFSCCode" Style="width:100%" />
                                </div>
                                <div class="col-md-2">
                                    <label>Lock</label><br />
                                    <RadzenSwitch TValue="bool" @bind-Value="newConsultant.Lock" />
                                </div>
                                <div class="col-md-2">
                                    <label>Limit</label>
                                    <RadzenNumeric @bind-Value="newConsultant.Limit" Style="width:100%" />
                                </div>

                                <div class="col-md-6">
                                    <label>Branch</label>
                                    <RadzenDropDown Data="@branches" TextProperty="BranchName" ValueProperty="BranchId" @bind-Value="newConsultant.BranchId" Style="width:100%" Placeholder="Select Branch" />
                                </div>
                            </div>

                            <div class="mt-3" style="display:flex; gap:8px; justify-content:flex-end;">
                                <button type="button"
                                        class="btn btn-primary"
                                        @onclick="OnAddSubmit"
                                        disabled="@IsSubmitting">
                                    @if (IsSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Submitting...</span>
                                    }
                                    else
                                    {
                                        <span>Submit</span>
                                    }
                                </button>
                                <button class="btn btn-secondary" @onclick="CloseAddModal">Cancel</button>
                                @* <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Submit" Type="Submit" />
                                <RadzenButton ButtonStyle="ButtonStyle.Secondary" Text="Cancel" Click="@CloseAddModal" /> *@
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }
}